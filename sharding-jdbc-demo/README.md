# Sharding JDBC - 分库分表

> 单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表

> 如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表

## 优势

+ 提高系统性能
+ 提高系统可用性
+ 提高系统可扩展性
+ 提高系统灵活性
+ 降低系统硬件成本

## 需要考虑的问题

+ 主键生成策略
+ 数据备份
+ 数据迁移
+ 分布式事务
+ SQL路由问题
  + 行SQL语句检索数据时，如何快速定位到目标数据所在的数据库服务
+ 跨节点查询, 归并问题
  + limit
  + order by
  + 等

## Mysql服务搭建

+ [单机Docker部署](https://github.com/chenqf/material/tree/main/01.Deploy/mysql#%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85)
+ [主从Docker部署](https://github.com/chenqf/material/tree/main/01.Deploy/mysql#%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4)

## 拆分方式

+ 垂直拆分
  + 分库
  + 分表
+ 水平拆分
  + 分库
  + 分表

### 垂直分表

业务表拆分为`主表`+`附表`

主表包含主要字段(列表查询字段), 附表包含非常用信息(详情页字段)

1. 避免单表占用磁盘过多/IO过大
2. 修改字段时, 锁表或锁行时影响更少

### 垂直分库

把单一数据库, 按照业务进行划分, 专库专表

TODO 跨库级联查询

### 水平分库

表中数据过大, 使用多个数据库来进行分担, 每个数据库结构相同

数据通过某种规则, 分配到不同的数据库中

### 水平分表

表中数据量过大, 使用多个表进行分担, 每个表结构相同

数据通过某种规则, 分贝到不同的表中

## 原则 


## 公共表 (字典表)

+ 存储固定数据的表 , 表数据很少发生变化, 查询时经常进行关联
+ 在每个数据库中创建相同结构的公共表

TODO 

## 读写分离

通过SQL语义分析, 实现读写分离, 将读写发送到不同的数据库中

@MasterOnly




每写一个sql都要考虑sql是怎么执行的

避免虚拟列查询, 会导致全分片查询

第一要务, 表数据分配均匀

时间分片,数据峰值不固定

## 分库分表策略


### inline策略 - 单一键分片
尽量不要用in (id1,id2,id3) , 确保id都在一个分片中, 否则会全分片表扫描
无法使用between查询, 需要单独配置允许范围查询 - 全分片表扫描


### complex策略 按多个分片键分片


### class_base策略 定制一个复杂的类实现分片策略

海量数据场景下, 不要使用存储过程


可分多个策略, 一个策略用于插入, 其他策略用于查询


mp 字段名尽量不要用id, 用了id, 默认吧id作为主键, 默认生成雪花算法, 不会将id交由shardingJDBC处理